
@{
    ViewBag.Title = "Budget Plan";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <h2>Budget Planner with jQuery Datatables</h2>

    <div class="panel panel-primary">
        <div class="panel-heading">Organization Budget Planning</div>
        <div class="panel-body">
            <div class="row">
                <div class="col-sm-2 text-right">Financial Year :</div>
                <div class="col-sm-4 text-left">
                    @Html.DropDownList("FinancialYear", (SelectList)ViewBag.FinancialYears, new { @class = "form-control", role = "menu", datatoggle = "dropdown" })
                </div>
                <div class="col-sm-2 text-right">Organization :</div>
                <div class="col-sm-4 text-left">
                    @Html.DropDownList("Organization", (SelectList)ViewBag.Organization, new { @class = "form-control", role = "menu", datatoggle = "dropdown" })
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    &nbsp;
                </div>
            </div>
            <div class="row">
                <div class="col-sm-1 text-right">
                    &nbsp;
                </div>
                <div class="col-sm-9 text-left">
                    <h4>Planner Status <span id="lblStatus" class="label label-info"></span></h4>
                </div>
                <div class="col-sm-1 text-right">
                    <button type="button" class="btn btn-info btn-sm" id="btnOpen">Open</button>
                </div>
                <div class="col-sm-1 text-right">

                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-1">
                &nbsp;
            </div>
            <div class="col-sm-10">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div class="table-responsive">
                            <table id="example" class="table table-striped table-hover stripe row-border order-column" style="width:100%"></table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-1">
                &nbsp;
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="myModal" role="dialog">
            <div class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-body">
                        <p>Please wait....</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts {
    <script>
        $(document).ready(function () {
            $("#btnOpen").click(function () {
                $("#myModal").modal({ backdrop: "static" });
                var Payload = { 'fyscalYear': $("#FinancialYear").val(), 'orgId': parseInt($("#Organization").val()) };
                $.ajax({
                    url: '/Home/GetBudgetPlanner',
                    type: 'POST',
                    data: Payload,
                    success: function (response) {
                        $("#lblStatus").text(response.plannerStatus);
                        if ($.fn.DataTable.isDataTable('#example')) {
                            $('#example').DataTable().destroy();
                            $('#example').empty();
                        }
                        //Listing Columns (Table Header) from json ajax response
                        var Columns = [];
                        var ColumnsDefs = [];
                        var TableHeader = "<thead><tr>";
                        $.each(response.columns, function (key, value) {
                            Columns.push({ "data": value });
                            TableHeader += "<th>" + value + "</th>";
                            var widthVal = key == 1 ? "100px" : "80px";
                            ColumnsDefs.push({
                                "visible": key > 0,
                                "orderable": key == 1,
                                "searchable": key == 1,
                                "width": widthVal,
                                render: function (data, type, row) {
                                    return '<input class="form-control" id="' + value + '" name="' + value + '" type="text"  value = "' + data + '" />';
                                },
                                "targets": key
                            });
                        });

                        TableHeader += "</thead></tr>";
                        $("#example").append(TableHeader);
                        $('#example').DataTable({
                            scrollY: "300px",
                            scrollX: true,
                            scrollCollapse: true,
                            fixedColumns: true,
                            fixedColumns: {
                                leftColumns: 2
                            },
                            data: response.budget,
                            columns: Columns,
                            columnDefs: ColumnsDefs
                        });
                        $("#myModal").modal('hide');
                    },
                    error: function (xher) {
                        $("#myModal").modal('hide');
                    }
                });
            });
        });
    </script>
}
